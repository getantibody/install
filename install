#!/bin/sh
set -e
DOWNLOAD_URL="https://github.com/getantibody/antibody/releases/download"
test -z "$TMPDIR" && TMPDIR="$(mktemp -d)"

die() {
  echo "$1"
  exit 1
}

last_version() {
  curl -s https://api.github.com/repos/getantibody/antibody/releases/latest |
    grep "\"tag_name\":" |
    sed -E "s/.*\"([^\"]+)\".*/\1/"
}

download() {
  os=$(uname -s)
  arch=$(uname -m)
  version="$(last_version)" || true
  test -z "$version" && die "Unable to get antibody version."
  echo "Downloading antibody $version for ${os}_${arch}..."
  rm -f /tmp/antibody.tar.gz
  curl -s -f -L -o /tmp/antibody.tar.gz \
    "$DOWNLOAD_URL/$version/antibody_${os}_${arch}.tar.gz" ||
      die "Download failed."
}

extract() {
  tar -xf /tmp/antibody.tar.gz -C "$TMPDIR"
}

download
extract || true
sudo mv -f "$TMPDIR"/antibody /usr/local/bin/antibody
which antibody
